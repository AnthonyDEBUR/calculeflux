---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{get-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(calculeflux)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand -->

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->


<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.

If it is the first time you use {fusen}, after 'description', you can directly run the last chunk of the present file with inflate() inside.
--> 


# Include some data examples in your package

<!-- 
 Store your dataset in a directory named "inst/" at the root of your project.
 Use it for your tests in this Rmd thanks to `pkgload::load_all()` to make it available
and `system.file()` to read it in your examples.

- There already is a dataset in the "inst/" directory to be used in the examples below
-->


# The first function of the package: calcule flux

<!--
Create a chunk for the core of the function

- The chunk needs to be named `function` at least
- It contains the code of a documented function
- The chunk can also be named `function-my_median` to make it easily
findable in your Rmd
- Let the `@examples` part empty, and use the next `examples` chunk instead to present reproducible examples

After inflating the template

-  This function code will automatically be added in a new file in the "R/" directory
-->





<!--
Create a chunk with an example of use for your function

- The chunk needs to be named `examples` at least
- It contains working examples of your function
- The chunk is better be named `examples-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This example will automatically be added in the '@examples' part of our function above in the "R/" directory
- This example will automatically be added in the vignette created from this Rmd template
-->


```{r examples}

date_debut_calcul<-"2007-01-01"%>%as.Date()
date_fin_calcul<-"2007-12-31"%>%as.Date()
  
datafile <- system.file("nitrates.csv", package = "calculeflux")
nitrates <- read.csv2(datafile, encoding = "UTF-8")
nitrates$DatePrel<-nitrates$DatePrel%>%as.Date()

datafile <- system.file("debit.csv", package = "calculeflux")
debit <- read.csv2(datafile, encoding = "UTF-8")
debit$date_obs_elab<-debit$date_obs_elab%>%as.Date()

calcule_flux(
  nitrates,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit,
  methode = "M6",
  date_debut_calcul=date_debut_calcul,
  date_fin_calcul=date_fin_calcul
)

methodes<-c("M1", "M2", "M3", "M4", "M5", "M6", "M9")

tmp<-lapply(methodes,
function(x){calcule_flux(
  nitrates,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit,
  methode = x,
  date_debut_calcul=date_debut_calcul,
  date_fin_calcul=date_fin_calcul
)}
)


tmp<-unlist(tmp)
tmp<-data.frame(methode=methodes, flux=tmp/1000)

library(ggplot2)

ggplot2::ggplot(tmp, ggplot2::aes(methode, flux)) + 
  ggplot2::geom_bar(stat="identity") + ggplot2::ylab("Flux en kg NO3/an")

# calcul du flux annuel méthode M6

calcul_flux_annuel<-function(annee)
{
  calcule_flux(
  nitrates,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit,
  methode = "M6",
  date_debut_calcul=paste0(annee,"-10-01")%>%as.Date(),
  date_fin_calcul=paste0((annee+1),"-10-01")%>%as.Date()
)
 
}

annees<-seq(2002,2021)
tmp<-lapply(annees, calcul_flux_annuel)

tmp<-unlist(tmp)
flux_vilaine_bdhydro<-data.frame(annee_hydro=paste0(annees, " - ", annees+1), flux=tmp/1000)


ggplot2::ggplot(flux_vilaine_bdhydro, ggplot2::aes(annee_hydro, flux)) +
  ggplot2::geom_bar(stat="identity") +
  ggplot2::ylab("flux (t NO3/an)") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust=0.5)) +
  ggplot2::ggtitle("Flux de nitrates calcul\u00e9s sur la Vilaine \u00e0 Rieux",
          subtitle="NO3 station 04216000 / station hydrom\u00e9trique J930061101")


# calcul du flux bimensuels pour chaque année


library(zoo)
DateSeq_fin_mois <- function(st, en, freq) {
  st <- as.Date(as.yearmon(st)) 
  en <- as.Date(as.yearmon(en)) 
  as.Date(as.yearmon(seq(st, en, by = paste(as.character(12/freq), "months"))), frac = 1)

}

DateSeq_debut_mois <- function(st, en, freq) {
  st <- as.Date(as.yearmon(st))
  en <- as.Date(as.yearmon(en)) 
  as.Date(as.yearmon(seq(st, en, by = paste(as.character(12/freq), "months"))), frac = 0)

}

# # dates de chaque fin de mois
# DateSeq_fin_mois(as.Date("2002-01-01"),as.Date("2022-09-30"),12)

# dates de debut de mois, un mois sur 2
dates_debut_mois<-DateSeq_debut_mois(as.Date("2002-10-01"),as.Date("2022-08-01"),6)

# dates des fins de mois 1 mois sur 2
dates_fin_mois<-DateSeq_fin_mois(as.Date("2002-11-30"),as.Date("2022-09-30"),6)

# mois periode 
mois_periode<-paste0(format(dates_debut_mois, "%b"),"-",format(dates_fin_mois, "%b"))
mois_periode<-mois_periode%>%factor(levels=unique(mois_periode))

# annnee hydro
an_hydro_periode<-ifelse(format(dates_debut_mois, "%m")%>%as.numeric()>=10,
                         format(dates_debut_mois, "%Y")%>%as.numeric(),
                         format(dates_debut_mois, "%Y")%>%as.numeric()-1)

an_hydro_periode<-paste0(an_hydro_periode, " - ", an_hydro_periode+1)

periodes<-data.frame(debut=dates_debut_mois,
                     fin=dates_fin_mois,
                     mois_periode=mois_periode,
                     an_hydro_periode=an_hydro_periode)


tmp<-lapply(seq(1,nrow(periodes)),
function(x){
  calcule_flux(
  nitrates,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit,
  methode = "M6",
  date_debut_calcul=periodes$debut[x],
  date_fin_calcul=periodes$fin[x]
)
  }
)


flux<-unlist(tmp)
resultats<-cbind(periodes, flux)



ggplot2::ggplot(resultats, ggplot2::aes(mois_periode, flux)) +
  ggplot2::geom_bar(stat="identity") +
  ggplot2::ylab("Flux en kg NO3/an") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust=0.5)) +
  ggplot2::facet_wrap(an_hydro_periode~.)+
  ggplot2::ggtitle("Flux de nitrates calcul\u00e9s sur la Vilaine \u00e0 Rieux",
          subtitle="NO3 station 04216000 / station hydrom\u00e9trique J930061101")




```

<!--
Create a chunk with a test of use for your function

- The chunk needs to be named `tests` at least
- It contains working tests of your function
- The chunk is better be named `tests-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This test code will automatically be added in the "tests/testthat/" directory
-->


<!--
There can be other functions, examples and tests in your flat template.
Each of them will be inflated in a different file, provided that there is a level-1 or level-2 section title to separate from previous functions.
-->



# calcule_hydraulicite

    

  

```{r example-calcule_hydraulicite}

date_debut_calcul<-"2022-09-15"%>%as.Date()
date_fin_calcul<-"2022-09-30"%>%as.Date()

datafile <- system.file("debit.csv", package = "calculeflux")
debit <- read.csv2(datafile, encoding = "UTF-8")
debit$date_obs_elab<-debit$date_obs_elab%>%as.Date()


calcule_hydraulicite(debit,
                     col_dates_debit="date_obs_elab",
                     col_debits="resultat_obs_elab",
                     date_debut_calcul,
                     date_fin_calcul)

# example 2

datafile <- system.file("debit.csv", package = "calculeflux")
debit <- read.csv2(datafile, encoding = "UTF-8")
debit$date_obs_elab<-debit$date_obs_elab%>%as.Date()

date_debut_calcul=paste0(seq(2002,2021),"-10-01")%>%as.Date
date_fin_calcul=paste0(seq(2003,2022),"-09-30")%>%as.Date

annees_hydro<-data.frame(date_debut_calcul=date_debut_calcul, 
                         date_fin_calcul=date_fin_calcul,
                         nom=paste0(seq(2002,2021),
                                    "-",
                                    seq(2003,2022)))



tmp<-lapply(seq(2002:2021),
function(x){calcule_hydraulicite(debit,
                     date_debut_calcul=annees_hydro$date_debut_calcul[x],
                     date_fin_calcul=annees_hydro$date_fin_calcul[x])
  }
)


tmp<-unlist(tmp)
tmp<-data.frame(annee=annees_hydro$nom, hydraulicite=tmp)


library(ggplot2)

ggplot2::ggplot(tmp, ggplot2::aes(annee, hydraulicite)) +
  ggplot2::geom_bar(stat="identity") +
  ggplot2::ylab("hydraulicite") + 
  ggplot2::geom_hline(yintercept=1)+
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust=0.5)) +
  ggplot2::ggtitle("Hydraulicit\u00e9 sur la Vilaine \u00e0 Rieux",
          subtitle="station hydrom\u00e9trique J930061101")



```

  

  
  

# importe_debit_dates_dispo

    

  

```{r example-importe_debit_dates_dispo}
importe_debit_dates_dispo()
```

  

    
  
  
  
  
  

# importe_debit

    

  

```{r example-importe_debit}
test_debit<-importe_debit(X=381425.6, 
                          Y=6755598, 
                          date_debut=as.Date("2010-01-01"), 
                          date_fin = as.Date("2010-01-17"))
```

```{r example-importe_debit2}
#CALCUL DU FLUX DE NITRATE SUR LE SEMNON
datafile <- system.file("donnees_nitrate_semnon.csv", package = "calculeflux")
nitrates_semnon <- read.csv2(datafile, 
                             encoding = "UTF-8",
                             colClasses=c("factor",
                                          "character",
                                          "numeric"),
                             dec=",")
#date mini et maxi
nitrates_semnon$DatePrel<-as.POSIXct(nitrates_semnon$DatePrel, format="%d/%m/%Y %H:%M")
summary(nitrates_semnon$DatePrel)


# import des débits sur le Semnon à Eancé
debit_semnon<-importe_debit(X=381425.6, 
                          Y=6755598, 
                          date_debut=as.Date("2010-10-01"), 
                          date_fin = as.Date("2022-09-30"))



# calcul du flux annuel sur la période
calcul_flux_annuel<-function(annee)
{
  calcule_flux(
  analyses=nitrates_semnon,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit=debit_semnon,
  methode = "M6",
  date_debut_calcul=paste0(annee,"-10-01")%>%as.Date(),
  date_fin_calcul=paste0((annee+1),"-10-01")%>%as.Date()
)
 
}



annees<-seq(2011,2021)
tmp<-lapply(annees, calcul_flux_annuel)
tmp<-unlist(tmp)
rslt_semnon<-data.frame(annee_hydro=paste0(annees, " - ", annees+1), flux=tmp/1000)


ggplot2::ggplot(rslt_semnon, ggplot2::aes(annee_hydro, flux)) +
  ggplot2::geom_bar(stat="identity") +
  ggplot2::ylab("flux (t NO3/an)") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust=0.5)) +
  ggplot2::ggtitle("Flux de nitrates calcul\u00e9s sur le Semnon \u00e0 Eanc\u00e9",
          subtitle="NO3 station 04211950 / d\u00e9bits 
          estim\u00e9s \u00e0 l\'aide de l\'API SIMFEN / GEOSAS")



##############################

#CALCUL DU FLUX DE NITRATE SUR LA VILAINE AVEC SIMFEN
datafile <- system.file("nitrates.csv", package = "calculeflux")
nitrates <- read.csv2(datafile, encoding = "UTF-8")


#date mini et maxi
nitrates$DatePrel<-nitrates$DatePrel%>%as.Date()
summary(nitrates$DatePrel)


# import des débits sur la Vilaine au niveau de la station hydro
debit_vilaine<-importe_debit(X=314920, 
                          Y=6732475, 
                          date_debut=as.Date("2010-10-01"), 
                          date_fin = as.Date("2022-09-30"))



# calcul du flux annuel sur la période
calcul_flux_annuel<-function(annee)
{
  calcule_flux(
  analyses=nitrates,
  col_dates_anal = "DatePrel",
  col_analyses = "RsAna",
  debit=debit_vilaine,
  methode = "M6",
  date_debut_calcul=paste0(annee,"-10-01")%>%as.Date(),
  date_fin_calcul=paste0((annee+1),"-10-01")%>%as.Date()
)
 
}



annees<-seq(2010,2021)
tmp<-lapply(annees, calcul_flux_annuel)

tmp<-unlist(tmp)
flux_vilaine_simfen<-data.frame(annee_hydro=paste0(annees, " - ", annees+1), flux=tmp/1000)


ggplot2::ggplot(flux_vilaine_simfen, ggplot2::aes(annee_hydro, flux)) +
  ggplot2::geom_bar(stat="identity") +
  ggplot2::ylab("flux (t NO3/an)") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust=0.5)) +
  ggplot2::ggtitle("Flux de nitrates calcul\u00e9s sur la Vilaine \u00e0 Rieux",
          subtitle="NO3 station 04216000 / d\u00e9bits 
          estim\u00e9s \u00e0 l\'aide de l\'API SIMFEN / GEOSAS")


```

  

 

# importe_BV_amont

    

  

```{r example-importe_BV_amont}
# Pt en Bretagne
shp<-importe_BV_amont(X=381425.6,
                      Y=6755598)

# Pt hors Bretagne
# shp<-importe_BV_amont(X=336599,
#                       Y=6674450)

plot(sf::st_geometry(shp))

```

  

   

# calcule_flux_annuels

    

  

```{r example-calcule_flux_annuels}
   

datafile <- system.file("nitrates.csv", package = "calculeflux")
nitrates <- read.csv2(datafile, encoding = "UTF-8")
nitrates$DatePrel<-nitrates$DatePrel%>%as.Date()


datafile <- system.file("debit.csv", package = "calculeflux")
debit <- read.csv2(datafile, encoding = "UTF-8")
debit$date_obs_elab<-debit$date_obs_elab%>%as.Date()

annees=c(2010,2014)
 mois_debut<-9
  


flux_vilaine<-calcule_flux_annuels(annees=c(2010,2021),
                     mois_debut=10,
                     analyses0=nitrates,
                     debit0=debit
                     )



```

  

  
  



## Use sub-functions in the same chunk

<!--

# There can be development actions

Create a chunk with 'development' actions

- The chunk needs to be named `development` or `dev`
- It contains functions that are used for package development only
- Note that you may want to store most of these functions in the 0-dev_history.Rmd file

These are only included in the present flat template file, their content will not be part of the package anywhere else.
-->


# Inflate your package

You're one inflate from paper to box.
Build your package from this very Rmd using `fusen::inflate()`

- Verify your `"DESCRIPTION"` file has been updated
- Verify your function is in `"R/"` directory
- Verify your test is in `"tests/testthat/"` directory
- Verify this Rmd appears in `"vignettes/"` directory

